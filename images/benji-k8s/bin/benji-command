#!/usr/bin/env python3
import sys
import time
from typing import Optional

from benji.helpers.prometheus import command_start_time, command_status_failed, command_status_succeeded, \
    command_registry, command_completion_time, command_runtime_seconds, push
from benji.helpers.settings import benji_log_level
from benji.helpers.utils import setup_logging, subprocess_run

setup_logging()

exception: Optional[Exception] = None
command = ' '.join(sys.argv[1:])
start_time = time.time()

command_start_time.labels(command=command).set(start_time)
try:
    subprocess_run(['benji', '--log-level', benji_log_level] + sys.argv[1:])
except Exception as exception:
    command_status_failed.labels(command=command).set(1)
    completion_time = time.time()
    command_completion_time.labels(command=command).set(completion_time)
    command_runtime_seconds.labels(command=command).set(completion_time - start_time)
    push(command_registry)
    raise exception
else:
    command_status_succeeded.labels(command=command).set(1)
    completion_time = time.time()
    command_completion_time.labels(command=command).set(completion_time)
    command_runtime_seconds.labels(command=command).set(completion_time - start_time)
    push(command_registry)
    sys.exit(0)
