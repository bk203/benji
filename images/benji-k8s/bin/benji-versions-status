#!/usr/bin/env python3
import sys

from benji.helpers.prometheus import older_incomplete_versions, version_status_registry, invalid_versions, push
from benji.helpers.settings import benji_log_level
from benji.helpers.utils import setup_logging, subprocess_run

setup_logging()

benji_ls_older_incomplete_versions = subprocess_run([
    'benji', '--machine-output', '--log-level', benji_log_level, 'ls', 'status == "incomplete" and date < "1 day ago"'
],
                                                    decode_json=True)

benji_ls_invalid_versions = subprocess_run(
    ['benji', '--machine-output', '--log-level', benji_log_level, 'ls', 'status == "invalid"'], decode_json=True)

older_incomplete_versions.set(len(benji_ls_older_incomplete_versions['versions']))
invalid_versions.set(len(benji_ls_invalid_versions['versions']))
push(version_status_registry)
sys.exit(0)
